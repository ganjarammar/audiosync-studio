name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Debug signing environment
        shell: pwsh
        run: |
          Write-Host "=== Checking Signing Setup ==="
          
          if ($env:TAURI_SIGNING_PRIVATE_KEY) {
            $keyLength = $env:TAURI_SIGNING_PRIVATE_KEY.Length
            $lines = ($env:TAURI_SIGNING_PRIVATE_KEY -split "`n")
            $firstLine = $lines[0].Trim()
            
            Write-Host "✅ Private key is set"
            Write-Host "   Total length: $keyLength chars"
            Write-Host "   Lines: $($lines.Count)"
            Write-Host "   First line starts: $($firstLine.Substring(0, [Math]::Min(30, $firstLine.Length)))..."
            
            if (-not $firstLine.StartsWith("untrusted comment:")) {
              Write-Warning "⚠️ First line should start with 'untrusted comment:'"
            }
          } else {
            Write-Error "❌ TAURI_SIGNING_PRIVATE_KEY not set!"
            exit 1
          }
          
          if ($env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD) {
            Write-Host "✅ Password is set (length: $($env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD.Length))"
          } else {
            Write-Error "❌ TAURI_SIGNING_PRIVATE_KEY_PASSWORD not set!"
            exit 1
          }
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri app
        shell: pwsh
        run: |
          Write-Host "=== Building with Tauri v2 ==="
          npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: List build output
        shell: pwsh
        run: |
          Write-Host "=== Build Output Files ==="
          $bundlePath = "src-tauri/target/release/bundle/nsis"
          Get-ChildItem -Path $bundlePath -File | Format-Table Name, Length -AutoSize

      - name: Verify signature files
        shell: pwsh
        run: |
          $exeFiles = Get-ChildItem "src-tauri/target/release/bundle/nsis/*.exe"
          $sigFiles = Get-ChildItem "src-tauri/target/release/bundle/nsis/*.sig" -ErrorAction SilentlyContinue
          
          Write-Host "EXE files: $($exeFiles.Count)"
          Write-Host "SIG files: $($sigFiles.Count)"
          
          if ($sigFiles.Count -eq 0) {
            Write-Error "❌ No signature files generated! Signing failed!"
            Write-Host "`nThis means either:"
            Write-Host "1. Private key format is wrong"
            Write-Host "2. Password is incorrect"
            Write-Host "3. Tauri signing is not working"
            exit 1
          }
          
          Write-Host "✅ Signature files created successfully!"

      - name: Generate latest.json
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $exeFile = Get-ChildItem "src-tauri/target/release/bundle/nsis/*.exe" | Select-Object -First 1
          $sigFile = Get-ChildItem "src-tauri/target/release/bundle/nsis/*.sig" | Select-Object -First 1
          
          $signature = (Get-Content $sigFile.FullName -Raw).Trim()
          
          $json = @{
            version = $version
            notes = "See the assets to download and install this version."
            pub_date = (Get-Date).ToUniversalTime().ToString("o")
            platforms = @{
              "windows-x86_64" = @{
                signature = $signature
                url = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$($exeFile.Name)"
              }
            }
          } | ConvertTo-Json -Depth 10
          
          $json | Out-File "latest.json" -Encoding utf8NoBOM
          Write-Host "Generated latest.json"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.sig
            latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}